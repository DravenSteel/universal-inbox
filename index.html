<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="manifest.json">
  <title>Life Library</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; background: #f0f2f5; color: #333; }
    
    /* Card Design */
    .card { background: white; padding: 24px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
    
    h2 { margin-top: 0; font-size: 22px; color: #1a1a1a; margin-bottom: 20px; }
    label { font-weight: 600; font-size: 13px; color: #666; display: block; margin-top: 16px; margin-bottom: 6px; }
    
    input, select, textarea { width: 100%; padding: 14px; box-sizing: border-box; border: 1px solid #e1e4e8; border-radius: 10px; font-size: 16px; font-family: inherit; background: #fafafa; transition: border 0.2s; }
    input:focus, select:focus, textarea:focus { border-color: #007bff; outline: none; background: #fff; }
    
    textarea { resize: vertical; min-height: 120px; line-height: 1.5; }
    
    button { padding: 16px; width: 100%; background: #222; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; margin-top: 24px; cursor: pointer; transition: opacity 0.2s; }
    button:active { opacity: 0.8; }
    
    .hidden { display: none; }
    
    #url-preview { font-size: 12px; color: #888; background: #f1f3f5; padding: 8px 12px; border-radius: 6px; margin-bottom: 10px; word-break: break-all; }
    
    /* Setup Screen Styling */
    .setup-box { text-align: center; }
    .setup-box input { margin-bottom: 15px; }
  </style>
</head>
<body>

  <div id="setup-view" class="hidden card setup-box">
    <h2>Connect Library</h2>
    <p style="color:#666; margin-bottom:20px;">Paste your Google Script URL to link this app to your Life Library.</p>
    <input type="text" id="script-url" placeholder="https://script.google.com/macros/s/...">
    <button onclick="saveConfig()">Connect</button>
  </div>

  <div id="form-view" class="hidden card">
    <h2 id="page-heading">Add Item</h2>
    
    <div id="link-section">
      <div id="url-preview"></div>
      <label>Title</label>
      <input type="text" id="title" placeholder="Page Title">
    </div>

    <label>Category</label>
    <select id="category">
      <option value="Inbox">ðŸ“¥ Inbox</option>
      <option value="Idea">ðŸ’¡ Idea</option>
      <option value="Buy">ðŸ›’ To Buy</option>
      <option value="Read">ðŸ“š To Read</option>
      <option value="Watch">ðŸŽ¬ To Watch</option>
      <option value="Listen">ðŸŽ§ To Listen</option>
    </select>

    <label id="note-label">Notes</label>
    <textarea id="note" placeholder="Add details..."></textarea>

    <button id="send-btn" onclick="sendData()">Save to Library</button>
    <div id="status" style="text-align:center; margin-top:15px; color:#666; font-size: 14px;"></div>
  </div>

  <script>
    const savedUrl = localStorage.getItem('google_script_url');
    let currentShareUrl = ""; 

    // DOM Elements
    const setupView = document.getElementById('setup-view');
    const formView = document.getElementById('form-view');
    const linkSection = document.getElementById('link-section');
    const pageHeading = document.getElementById('page-heading');
    const noteLabel = document.getElementById('note-label');
    
    const titleInput = document.getElementById('title');
    const categoryInput = document.getElementById('category');
    const noteInput = document.getElementById('note');
    const urlPreview = document.getElementById('url-preview');
    const sendBtn = document.getElementById('send-btn');
    const statusDiv = document.getElementById('status');

    // 1. INITIALIZE APP
    if (!savedUrl) {
      setupView.classList.remove('hidden');
    } else {
      initialize();
    }

    // 2. DETECT CONTEXT (Direct vs Share)
    function initialize() {
      const params = new URLSearchParams(window.location.search);
      const sharedUrl = params.get('url') || params.get('text') || "";
      const sharedTitle = params.get('title') || "";

      formView.classList.remove('hidden');

      if (!sharedUrl) {
        // --- MODE: DIRECT OPEN (IDEA) ---
        pageHeading.innerText = "New Idea";
        linkSection.style.display = 'none';
        
        categoryInput.value = "Idea";
        noteLabel.innerText = "What's on your mind?";
        noteInput.placeholder = "Type your idea here...";
        noteInput.focus();
        
        currentShareUrl = "Direct Entry"; // Placeholder so DB isn't empty
        
      } else {
        // --- MODE: SHARE TARGET (LINK) ---
        pageHeading.innerText = "Save to Library";
        linkSection.style.display = 'block';
        
        categoryInput.value = "Inbox";
        noteLabel.innerText = "Notes";
        
        currentShareUrl = sharedUrl;
        urlPreview.innerText = sharedUrl;
        titleInput.value = sharedTitle;
      }
    }

    // 3. SEND DATA TO GOOGLE
    async function sendData() {
      const category = categoryInput.value;
      const title = titleInput.value;
      const note = noteInput.value;

      sendBtn.disabled = true;
      sendBtn.innerText = "Saving...";
      sendBtn.style.opacity = "0.7";

      try {
        // We use 'no-cors' mode standard for GAS web apps
        await fetch(`${savedUrl}?url=${encodeURIComponent(currentShareUrl)}&category=${encodeURIComponent(category)}&title=${encodeURIComponent(title)}&note=${encodeURIComponent(note)}`, {
          mode: 'no-cors'
        });

        // Success UI
        sendBtn.innerText = "Saved!";
        sendBtn.style.background = "#28a745";
        sendBtn.style.opacity = "1";
        statusDiv.innerText = "Done";
        
        // Auto-close logic
        setTimeout(() => {
           // If direct mode, we could reload to allow another entry, 
           // but closing is standard behavior for a 'capture' tool.
           window.close(); 
        }, 800);

      } catch (err) {
        sendBtn.disabled = false;
        sendBtn.innerText = "Retry";
        sendBtn.style.opacity = "1";
        statusDiv.innerText = "Error: " + err.message;
      }
    }

    // 4. SAVE CONFIG
    function saveConfig() {
      const inputUrl = document.getElementById('script-url').value;
      if (inputUrl.includes("script.google.com")) {
        localStorage.setItem('google_script_url', inputUrl);
        location.reload();
      } else {
        alert("Please enter a valid Google Script URL");
      }
    }
    
    // Register PWA Service Worker
    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js'); }
  </script>
</body>
</html>
